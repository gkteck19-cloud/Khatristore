<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khatri Admin - ‡§Æ‡§æ‡§Å ‡§≠‡§ó‡§µ‡§§‡•Ä ‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï‡§≤‡•ç‡§∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 pb-20 p-4">

    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-black mb-6 bg-slate-900 text-white p-4 rounded-2xl shadow-lg">üì¶ ‡§è‡§°‡§Æ‡§ø‡§® ‡§ê‡§™</h1>

        <div class="bg-white p-6 rounded-2xl shadow-sm mb-8 border-t-4 border-orange-500">
            <h2 class="font-bold text-lg mb-4 text-orange-600">‡§®‡§Ø‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡•ú‡•á‡§Ç</h2>
            <div class="grid gap-4">
                <input type="text" id="new-name" placeholder="‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ" class="w-full border p-3 rounded-xl text-sm">
                
                <div class="border-2 border-dashed border-gray-300 p-4 rounded-xl text-center">
                    <input type="file" id="image-input" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('image-input').click()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold">
                        üì∑ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç ‡§Ø‡§æ ‡§ñ‡•Ä‡§Ç‡§ö‡•á‡§Ç
                    </button>
                    <p id="upload-status" class="text-[10px] text-gray-500 mt-2">‡§ï‡•ã‡§à ‡§´‡•ã‡§ü‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡•Ä ‡§ó‡§à</p>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="new-price" placeholder="‡§ï‡•Ä‡§Æ‡§§ (‚Çπ)" class="border p-3 rounded-xl text-sm">
                    <input type="number" id="new-stock" placeholder="‡§∏‡•ç‡§ü‡•â‡§ï" class="border p-3 rounded-xl text-sm">
                </div>
                
                <button id="add-btn" onclick="addNewProduct()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow-md">
                    ‡§¶‡•Å‡§ï‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                </button>
            </div>
        </div>

        <div id="admin-product-list" class="space-y-4">
            <p class="text-center text-gray-400">‡§∏‡§æ‡§Æ‡§æ‡§® ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhNDgsAtOsxdfNGfTEqbuQoYgbtTjUSVo",
            authDomain: "khatri-online.firebaseapp.com",
            projectId: "khatri-online",
            storageBucket: "khatri-online.appspot.com", // ‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§¨‡§ï‡•á‡§ü ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
            messagingSenderId: "117940742720",
            appId: "1:117940742720:web:5d7dce7c186199e9fbcda5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let uploadedImageUrl = "";

        // --- 1. ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ---
        document.getElementById('image-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const status = document.getElementById('upload-status');
            status.innerText = "‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡•Å‡§ï‡•á‡§Ç";
            status.className = "text-[10px] text-orange-500 mt-2 animate-pulse";

            try {
                const storageRef = ref(storage, 'products/' + Date.now() + "_" + file.name);
                await uploadBytes(storageRef, file);
                uploadedImageUrl = await getDownloadURL(storageRef);
                
                status.innerText = "‚úÖ ‡§´‡•ã‡§ü‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à!";
                status.className = "text-[10px] text-green-600 mt-2 font-bold";
            } catch (error) {
                alert("‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§´‡•á‡§≤: " + error.message);
                status.innerText = "‚ùå ‡§è‡§∞‡§∞ ‡§Ü‡§à";
            }
        };

        // --- 2. ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡§æ ---
        window.addNewProduct = async () => {
            const name = document.getElementById('new-name').value;
            const price = Number(document.getElementById('new-price').value);
            const stock = Number(document.getElementById('new-stock').value);

            if (!name || !price || !uploadedImageUrl) {
                return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ, ‡§ï‡•Ä‡§Æ‡§§ ‡§î‡§∞ ‡§´‡•ã‡§ü‡•ã ‡§§‡•Ä‡§®‡•ã‡§Ç ‡§≠‡§∞‡•á‡§Ç!");
            }

            const btn = document.getElementById('add-btn');
            btn.innerText = "‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "products"), {
                    name, price, stock, image: uploadedImageUrl, createdAt: serverTimestamp()
                });
                alert("‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¶‡•Å‡§ï‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡•ú ‡§ó‡§Ø‡§æ ‡§π‡•à!");
                location.reload();
            } catch (e) {
                alert(e.message);
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="font-bold text-lg mb-4 text-blue-600">‡§®‡§è ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏</h2>
            <div id="admin-order-list" class="space-y-4 text-sm">
                <p class="text-gray-400 text-center">‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</p>
            </div>
        </div>
    </div>

    <audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhNDgsAtOsxdfNGfTEqbuQoYgbtTjUSVo",
            authDomain: "khatri-online.firebaseapp.com",
            projectId: "khatri-online",
            storageBucket: "khatri-online.firebasestorage.app",
            messagingSenderId: "117940742720",
            appId: "1:117940742720:web:5d7dce7c186199e9fbcda5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§ú‡•ã‡•ú‡§®‡§æ ---
        window.addNewProduct = async () => {
            const name = document.getElementById('new-name').value;
            const price = Number(document.getElementById('new-price').value);
            const stock = Number(document.getElementById('new-stock').value);
            const image = document.getElementById('new-image').value;

            if(!name || !price) return alert("‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§ï‡•Ä‡§Æ‡§§ ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!");

            try {
                await addDoc(collection(db, "products"), {
                    name, price, stock, image, createdAt: serverTimestamp()
                });
                alert("‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•Å‡•ú ‡§ó‡§Ø‡§æ!");
                location.reload();
            } catch (e) { alert(e.message); }
        };

        // --- 2. ‡§∏‡•ç‡§ü‡•â‡§ï ‡§≤‡•ã‡§° ‡§î‡§∞ ‡§≤‡§æ‡§á‡§µ ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ ---
        async function loadAdminData() {
            // ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏
            const pSnapshot = await getDocs(collection(db, "products"));
            let pHtml = "";
            pSnapshot.forEach((pDoc) => {
                const p = pDoc.data();
                pHtml += `
                    <div class="flex flex-col md:flex-row justify-between items-start p-3 border rounded-xl gap-2 bg-slate-50">
                        <span class="font-bold text-xs w-full md:w-40">${p.name}</span>
                        <div class="flex gap-2 w-full justify-end">
                            <input type="number" id="price-${pDoc.id}" value="${p.price}" class="w-16 border p-1 rounded text-xs">
                            <input type="number" id="stock-${pDoc.id}" value="${p.stock}" class="w-12 border p-1 rounded text-xs">
                            <button onclick="updateProduct('${pDoc.id}')" class="bg-slate-900 text-white px-3 py-1 rounded text-xs">Save</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('admin-product-list').innerHTML = pHtml;

            // ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ (Live Update)
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                let oHtml = "";
                let index = 0;
                snapshot.forEach((oDoc) => {
                    const o = oDoc.data();
                    if(index === 0 && snapshot.metadata.hasPendingWrites === false) {
                        // ‡§®‡§è ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§™‡§∞ ‡§ò‡§Ç‡§ü‡•Ä ‡§¨‡§ú‡§æ‡§è‡§Ç (‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§™‡§∞‡§Æ‡§ø‡§∂‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶)
                        document.getElementById('orderSound').play().catch(e => {});
                    }
                    oHtml += `
                        <div class="p-3 bg-white rounded-xl border-l-4 border-blue-500 shadow-sm">
                            <p class="text-blue-700 font-bold">‡§Ü‡§∞‡•ç‡§°‡§∞: ‚Çπ${o.total}</p>
                            <p><b>‡§´‡•ã‡§®:</b> ${o.phone}</p>
                            <p class="text-gray-600"><b>‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏:</b> ${o.items.map(i => i.name).join(', ')}</p>
                        </div>
                    `;
                    index++;
                });
                document.getElementById('admin-order-list').innerHTML = oHtml || "‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
            });
        }

        window.updateProduct = async (id) => {
            const price = Number(document.getElementById(`price-${id}`).value);
            const stock = Number(document.getElementById(`stock-${id}`).value);
            try {
                await updateDoc(doc(db, "products", id), { price, stock });
                alert("‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
            } catch (e) { alert(e.message); }
        };

        loadAdminData();
    </script>
</body>
</html>
