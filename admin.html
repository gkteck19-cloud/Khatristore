<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khatri Admin - ‡§Æ‡§æ‡§Å ‡§≠‡§ó‡§µ‡§§‡•Ä ‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï‡§≤‡•ç‡§∏</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 pb-20">

    <div class="max-w-4xl mx-auto p-4">
        <h1 class="text-2xl font-black mb-6 border-b pb-2 flex justify-between items-center">
            <span>üì¶ ‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤</span>
            <span class="text-xs bg-slate-800 text-white px-3 py-1 rounded-full italic">Khatri Store</span>
        </h1>

        <div class="bg-white p-6 rounded-2xl shadow-sm mb-8 border-t-4 border-orange-500">
            <h2 class="font-bold text-lg mb-4 text-orange-600">‡§®‡§Ø‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¶‡•Å‡§ï‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡•ú‡•á‡§Ç</h2>
            <div class="grid gap-3">
                <input type="text" id="new-name" placeholder="‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ" class="w-full border p-2 rounded-lg text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="new-price" placeholder="‡§ï‡•Ä‡§Æ‡§§ (‚Çπ)" class="border p-2 rounded-lg text-sm">
                    <input type="number" id="new-stock" placeholder="‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ" class="border p-2 rounded-lg text-sm">
                </div>
                <input type="text" id="new-image" placeholder="‡§´‡•ã‡§ü‡•ã ‡§≤‡§ø‡§Ç‡§ï (URL)" class="w-full border p-2 rounded-lg text-sm">
                <button onclick="addNewProduct()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow-md">Add Product</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm mb-8">
            <h2 class="font-bold text-lg mb-4 text-slate-800">‡§∏‡•ç‡§ü‡•â‡§ï ‡§î‡§∞ ‡§ï‡•Ä‡§Æ‡§§ ‡§¨‡§¶‡§≤‡•á‡§Ç</h2>
            <div id="admin-product-list" class="space-y-4">
                <p class="animate-pulse text-gray-400 text-center">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm">
            <h2 class="font-bold text-lg mb-4 text-blue-600">‡§®‡§è ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏</h2>
            <div id="admin-order-list" class="space-y-4 text-sm">
                <p class="text-gray-400 text-center">‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</p>
            </div>
        </div>
    </div>

    <audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhNDgsAtOsxdfNGfTEqbuQoYgbtTjUSVo",
            authDomain: "khatri-online.firebaseapp.com",
            projectId: "khatri-online",
            storageBucket: "khatri-online.firebasestorage.app",
            messagingSenderId: "117940742720",
            appId: "1:117940742720:web:5d7dce7c186199e9fbcda5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§ú‡•ã‡•ú‡§®‡§æ ---
        window.addNewProduct = async () => {
            const name = document.getElementById('new-name').value;
            const price = Number(document.getElementById('new-price').value);
            const stock = Number(document.getElementById('new-stock').value);
            const image = document.getElementById('new-image').value;

            if(!name || !price) return alert("‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§ï‡•Ä‡§Æ‡§§ ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!");

            try {
                await addDoc(collection(db, "products"), {
                    name, price, stock, image, createdAt: serverTimestamp()
                });
                alert("‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•Å‡•ú ‡§ó‡§Ø‡§æ!");
                location.reload();
            } catch (e) { alert(e.message); }
        };

        // --- 2. ‡§∏‡•ç‡§ü‡•â‡§ï ‡§≤‡•ã‡§° ‡§î‡§∞ ‡§≤‡§æ‡§á‡§µ ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ ---
        async function loadAdminData() {
            // ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏
            const pSnapshot = await getDocs(collection(db, "products"));
            let pHtml = "";
            pSnapshot.forEach((pDoc) => {
                const p = pDoc.data();
                pHtml += `
                    <div class="flex flex-col md:flex-row justify-between items-start p-3 border rounded-xl gap-2 bg-slate-50">
                        <span class="font-bold text-xs w-full md:w-40">${p.name}</span>
                        <div class="flex gap-2 w-full justify-end">
                            <input type="number" id="price-${pDoc.id}" value="${p.price}" class="w-16 border p-1 rounded text-xs">
                            <input type="number" id="stock-${pDoc.id}" value="${p.stock}" class="w-12 border p-1 rounded text-xs">
                            <button onclick="updateProduct('${pDoc.id}')" class="bg-slate-900 text-white px-3 py-1 rounded text-xs">Save</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('admin-product-list').innerHTML = pHtml;

            // ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ (Live Update)
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                let oHtml = "";
                let index = 0;
                snapshot.forEach((oDoc) => {
                    const o = oDoc.data();
                    if(index === 0 && snapshot.metadata.hasPendingWrites === false) {
                        // ‡§®‡§è ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§™‡§∞ ‡§ò‡§Ç‡§ü‡•Ä ‡§¨‡§ú‡§æ‡§è‡§Ç (‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§™‡§∞‡§Æ‡§ø‡§∂‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶)
                        document.getElementById('orderSound').play().catch(e => {});
                    }
                    oHtml += `
                        <div class="p-3 bg-white rounded-xl border-l-4 border-blue-500 shadow-sm">
                            <p class="text-blue-700 font-bold">‡§Ü‡§∞‡•ç‡§°‡§∞: ‚Çπ${o.total}</p>
                            <p><b>‡§´‡•ã‡§®:</b> ${o.phone}</p>
                            <p class="text-gray-600"><b>‡§Ü‡§á‡§ü‡§Æ‡•ç‡§∏:</b> ${o.items.map(i => i.name).join(', ')}</p>
                        </div>
                    `;
                    index++;
                });
                document.getElementById('admin-order-list').innerHTML = oHtml || "‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
            });
        }

        window.updateProduct = async (id) => {
            const price = Number(document.getElementById(`price-${id}`).value);
            const stock = Number(document.getElementById(`stock-${id}`).value);
            try {
                await updateDoc(doc(db, "products", id), { price, stock });
                alert("‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
            } catch (e) { alert(e.message); }
        };

        loadAdminData();
    </script>
</body>
</html>
